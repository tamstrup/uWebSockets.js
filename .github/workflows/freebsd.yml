name: Build/Release FreeBSD

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build-freebsd:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          show-progress: false
      - name: Build node modules
        uses: vmactions/freebsd-vm@v1.2.6
        with:
          run: |
            # Add __linux define and modify OS string
            echo '#define __linux 1' > build.c.temp
            cat build.c >> build.c.temp
            mv build.c.temp build.c
            sed -i.bak 's|#define OS "linux"|#define OS "freebsd"|' build.c && rm -f build.c.bak
            sed -i.bak 's/clang-18/clang18/' build.c && rm -f build.c.bak
            sed -i.bak 's/clang++-18/clang++18/' build.c && rm -f build.c.bak
            
            pkg install -y cmake llvm18 libuv v8
            
            make

            git fetch origin binaries:binaries
            git checkout binaries
            cp dist/*.node .
            cp dist/*.js .
            git status
            git rev-parse master > source_commit
            git checkout master docs/index.d.ts && mv docs/index.d.ts .
            git config --global user.email "patrick@tamstrup.dk"
            git config --global user.name "Patrick Tamstrup"
            git commit -a -m "[GitHub Actions] Updated FreeBSD binaries" || true
            git push "https://tamstrup:${{ secrets.SECRET }}@github.com/${{ github.repository }}" binaries
            git checkout master -- tests/smoke.js
            npm install ws
            node tests/smoke.js
            
